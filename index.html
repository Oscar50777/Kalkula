<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор себестоимости — 4 фрейма</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h2 {
      text-align: center;
    }

    .summary-buttons {
      text-align: center;
      margin-bottom: 20px;
    }

    .summary-buttons button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .summary-result {
      font-weight: bold;
      font-size: 18px;
      margin-top: 10px;
    }

    .summary-description {
      font-size: 14px;
      margin-top: 10px;
      white-space: pre-wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    td {
      border: none;
      padding: 10px;
      text-align: center;
    }

    .frame-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #f9f9f9;
    }

    .client-request {
      padding: 8px;
      font-size: 14px;
      width: 100%;
    }

    iframe {
      width: 100%;
      height: 400px;
      border: none;
      background-color: #fff;
    }
  </style>
</head>
<body>

<h2>Калькулятор себестоимости — 4 экземпляра</h2>

<!-- Блок кнопок и вывода -->
<div class="summary-buttons">
  <button onclick="sumPrices([0, 1])">Сумма 1+2</button>
  <button onclick="sumPrices([0, 1, 2])">Сумма 1+2+3</button>
  <button onclick="sumPrices([0, 1, 2, 3])">Сумма 1+2+3+4</button>
  <div class="summary-result">Итого: <span id="totalSum">0</span> руб.</div>
  <div class="summary-description" id="summaryDescription"></div>
</div>

<!-- Таблица с iframe и запросами клиентов -->
<table>
  <tr>
    <td>
      <div class="frame-container">
        <label>Запрос клиента:</label>
        <input type="text" class="client-request" oninput="updateRequest(0)">
        <iframe src="calculator.html" title="Фрейм 1"></iframe>
      </div>
    </td>
    <td>
      <div class="frame-container">
        <label>Запрос клиента:</label>
        <input type="text" class="client-request" oninput="updateRequest(1)">
        <iframe src="calculator.html" title="Фрейм 2"></iframe>
      </div>
    </td>
  </tr>
  <tr>
    <td>
      <div class="frame-container">
        <label>Запрос клиента:</label>
        <input type="text" class="client-request" oninput="updateRequest(2)">
        <iframe src="calculator.html" title="Фрейм 3"></iframe>
      </div>
    </td>
    <td>
      <div class="frame-container">
        <label>Запрос клиента:</label>
        <input type="text" class="client-request" oninput="updateRequest(3)">
        <iframe src="calculator.html" title="Фрейм 4"></iframe>
      </div>
    </td>
  </tr>
</table>

<script>
  const frames = window.frames; // Все iframe на странице
  const priceData = [null, null, null, null]; // Хранилище цен по индексам
  const productInfo = ['', '', '', '']; // Хранение описания
  const clientRequests = ['', '', '', '']; // Хранение запросов клиентов

  // Слушатель сообщений от iframe
  window.addEventListener("message", function(event) {
    if (event.data && event.data.type === "lastPrice") {
      const iframeIndex = Array.from(frames).indexOf(event.source);
      if (iframeIndex >= 0) {
        priceData[iframeIndex] = event.data.price;
        productInfo[iframeIndex] = event.data.description || '';
      }
    }
  });

  // Сохраняем запрос клиента при вводе
  function updateRequest(index) {
    const inputs = document.querySelectorAll('.client-request');
    if (inputs[index]) {
      clientRequests[index] = inputs[index].value;
    }
  }

  // Функция для подсчёта суммы выбранных iframe
  function sumPrices(indices) {
    let total = 0;
    let description = '';
    indices.forEach((i) => {
      if (priceData[i] !== null) {
        total += priceData[i];
        description += `Фрейм ${i + 1}:\n`;
        description += `Запрос: «${clientRequests[i] || '—'}»\n`;
        description += `Результат: ${productInfo[i]}\n\n`;
      }
    });
    document.getElementById("totalSum").textContent = total.toFixed(2);
    description += `Итого: ${total.toFixed(2)} руб.`;
    document.getElementById("summaryDescription").textContent = description;
  }
</script>

</body>
</html>
