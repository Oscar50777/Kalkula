<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор себестоимости</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial;
      margin: 0;
      padding: 10px;
      max-width: 100%;
      box-sizing: border-box;
    }
    h2 {
      text-align: center;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .left,
    .right {
      width: 100%;
    }
    label {
      font-size: 14px;
      margin-top: 8px;
    }
    input[type="number"],
    select,
    button,
    textarea {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .format-buttons,
    .paper-type-buttons,
    .quantity-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .format-buttons button,
    .paper-type-buttons button,
    .quantity-buttons button {
      padding: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    .side-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .side-buttons button {
      flex: 1 1 45%;
      padding: 8px;
      font-size: 14px;
    }
    .selected {
      background-color: #007BFF;
      color: white;
    }
    table.result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 15px;
      overflow-x: auto;
    }
    table.result-table th,
    table.result-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      white-space: nowrap;
    }
    table.result-table tr:hover {
      background-color: #f9f9f9;
    }
    .saved-list {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    .saved-item {
      background: #f9f9f9;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
    .settings-panel {
      display: none;
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
    .sub-field {
      margin-left: 15px;
      margin-top: 5px;
    }
    .remember-btn {
      padding: 4px 8px;
      font-size: 12px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .remember-btn:hover {
      background-color: #218838;
    }
    #statusMessage {
      color: red;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #productTypeButtons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 15px;
    }
    #productTypeButtons button {
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #productTypeButtons button.selected {
      background-color: #007BFF;
      color: white;
    }
    @media (max-width: 768px) {
      .remember-btn {
        font-size: 11px;
        padding: 3px 6px;
      }
      .side-buttons button {
        font-size: 13px;
        padding: 6px;
      }
      .format-buttons button,
      .paper-type-buttons button,
      .quantity-buttons button {
        font-size: 12px;
        padding: 6px;
      }
    }
    @media (max-width: 480px) {
      h2 {
        font-size: 16px;
      }
      label {
        font-size: 13px;
      }
      input[type="number"], select, button {
        font-size: 14px;
      }
      .format-buttons,
      .paper-type-buttons,
      .quantity-buttons {
        grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
      }
    }
  </style>
</head>
<body>
<h2>Калькулятор себестоимости по форматам бумаги</h2>

<!-- Блок с продукцией (перенесён наверх) -->
<div id="productTypeButtons">
  <button type="button" onclick="selectProductType(this)" data-type="Визитки">Визитки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Буклеты">Буклеты</button>
  <button type="button" onclick="selectProductType(this)" data-type="Листовки">Листовки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Флаеры">Флаеры</button>
  <button type="button" onclick="selectProductType(this)" data-type="Календари">Календари</button>
  <button type="button" onclick="selectProductType(this)" data-type="Плакаты">Плакаты</button>
  <button type="button" onclick="selectProductType(this)" data-type="Папки">Папки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Пакеты">Пакеты</button>
  <button type="button" onclick="selectProductType(this)" data-type="Открытки">Открытки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Блокноты">Блокноты</button>
  <button type="button" onclick="selectProductType(this)" data-type="Наклейки бумажные">Наклейки бумажные</button>
  <button type="button" onclick="selectProductType(this)" data-type="Бланки">Бланки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Карточки">Карточки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Бирки">Бирки</button>
  <button type="button" onclick="selectProductType(this)" data-type="Хенгеры">Хенгеры</button>
  <button type="button" onclick="selectProductType(this)" data-type="Дипломы">Дипломы</button>
</div>

<!-- Сообщение -->
<div id="statusMessage"></div>

<!-- Запрос клиента -->
<div style="margin-bottom: 15px;">
  <label>Запрос клиента:</label>
  <textarea id="clientRequestInput" rows="4" style="width: 100%;"></textarea>
</div>

<!-- Настройка печати -->
<div style="margin-bottom: 15px;">
  <button onclick="togglePrintSettings()" id="btnPrint">⚙️ Настройка печати ▼</button>
  <div id="printSettingsPanel" class="settings-panel">
    <label>Печать SRA3 (копия)</label><input type="number" id="printCostZ" value="15">
    <label>Приладка SRA3</label><input type="number" id="setupPrintZ" value="300">
    <label>Печать B2 (копия)</label><input type="number" id="printCostE" value="50">
    <label>Приладка B2</label><input type="number" id="setupPrintE" value="500">
    <label>Офсет А2 (копия)</label><input type="number" id="printCostOffsetA2" value="2">
    <label>Приладка А2</label><input type="number" id="setupPrintOffsetA2" value="10000">
  </div>
</div>

<!-- Послепечатные работы -->
<div style="margin-bottom: 15px;">
  <button onclick="togglePostpress()" id="btnPostpress">⚙️ Послепечатные работы ▼</button>
  <div id="postpressPanel" class="settings-panel">
    <!-- Резка -->
    <label><input type="checkbox" id="cuttingEnabled" checked onchange="updateSubFields()"> Резка</label>
    <div class="sub-field" id="cuttingOptions">
      <label>Стоимость резки за лист:</label>
      <input type="number" id="cuttingCostSetting" value="1" oninput="onInputChange()">
      <label>Настройка резки:</label>
      <input type="number" id="setupCutting" value="300" oninput="onInputChange()">
    </div>
    <!-- Ламинация -->
    <label><input type="checkbox" id="laminationEnabled" onchange="updateSubFields()"> Ламинация</label>
    <div class="sub-field" id="laminationOptions" style="display:none;">
      <label>Цена ламинации за лист:</label>
      <input type="number" id="laminationCost" value="12" oninput="onInputChange()">
      <label>Настройка ламинации:</label>
      <input type="number" id="setupLamination" value="300" oninput="onInputChange()">
      <label><input type="radio" name="laminationSides" value="1+0" checked> Односторонняя</label>
      <label><input type="radio" name="laminationSides" value="1+1"> Двусторонняя</label>
    </div>
    <!-- Биговка -->
    <label><input type="checkbox" id="scoreEnabled" onchange="updateSubFields()"> Биговка</label>
    <div class="sub-field" id="scoreOptions" style="display:none;">
      <label>Стоимость одного бига:</label>
      <input type="number" id="scoreCost" value="2" oninput="onInputChange()">
      <label>Настройка биговки:</label>
      <input type="number" id="setupScore" value="300" oninput="onInputChange()">
      <label>Бигов на изделие:</label>
      <input type="number" id="scoreCountInput" value="2" oninput="onInputChange()">
    </div>
    <!-- Фальцовка -->
    <label><input type="checkbox" id="foldingEnabled" onchange="updateSubFields()"> Фальцовка</label>
    <div class="sub-field" id="foldingOptions" style="display:none;">
      <label>Цена фальцовки за изделие:</label>
      <input type="number" id="foldingCostSetting" value="1" oninput="onInputChange()">
      <label>Настройка фальцовки:</label>
      <input type="number" id="setupFolding" value="300" oninput="onInputChange()">
    </div>
    <!-- Вырубка -->
    <label><input type="checkbox" id="diecutEnabled" onchange="updateSubFields()"> Вырубка</label>
    <div class="sub-field" id="diecutOptions" style="display:none;">
      <label>Цена вырубки за изделие:</label>
      <input type="number" id="diecutCostSetting" value="5" oninput="onInputChange()">
      <label>Настройка вырубки:</label>
      <input type="number" id="setupDiecut" value="5000" oninput="onInputChange()">
      <label>Стоимость штампа:</label>
      <input type="number" id="diecutStampCostSetting" value="5500" oninput="onInputChange()">
    </div>
    <!-- УФ-лак -->
    <label><input type="checkbox" id="uvLacquerEnabled" onchange="updateSubFields()"> УФ-лак</label>
    <div class="sub-field" id="uvLacquerOptions" style="display:none;">
      <label>Цена УФ-лака за лист:</label>
      <input type="number" id="uvLacquerCostSetting" value="10" oninput="onInputChange()">
      <label>Настройка УФ-лака:</label>
      <input type="number" id="setupUvLacquer" value="5000" oninput="onInputChange()">
    </div>
    <!-- Тиснение -->
    <label><input type="checkbox" id="embossingEnabled" onchange="updateSubFields()"> Тиснение</label>
    <div class="sub-field" id="embossingOptions" style="display:none;">
      <label>Цена тиснения за изделие:</label>
      <input type="number" id="embossingCostSetting" value="10" oninput="onInputChange()">
      <label>Настройка тиснения:</label>
      <input type="number" id="setupEmbossing" value="4500" oninput="onInputChange()">
      <label>Стоимость клише:</label>
      <input type="number" id="embossingKlischeCostSetting" value="2000" oninput="onInputChange()">
    </div>
    <!-- Сборка -->
    <label><input type="checkbox" id="assemblyEnabled" onchange="updateSubFields()"> Сборка</label>
    <div class="sub-field" id="assemblyOptions" style="display:none;">
      <label>Цена сборки за изделие:</label>
      <input type="number" id="assemblyCostSetting" value="5" oninput="onInputChange()">
      <label>Настройка сборки:</label>
      <input type="number" id="setupAssembly" value="300" oninput="onInputChange()">
    </div>
  </div>
</div>

<!-- Основная форма -->
<div class="main-container">
  <!-- Левая часть -->
  <div class="left">
    <label>Ширина (мм):</label>
    <input type="number" id="width" value="50" oninput="onInputChange();">
    <label>Высота (мм):</label>
    <input type="number" id="height" value="90" oninput="onInputChange();">
    <div class="format-buttons" id="formatButtons">
      <button onclick="setFormat('50×90')">50×90</button>
      <button onclick="setFormat('85×55')">85×55</button>
      <button onclick="setFormat('90×90')">90×90</button>
      <button onclick="setFormat('70×100')">70×100</button>
      <button onclick="setFormat('100×100')">100×100</button>
      <button onclick="setFormat('99×210')">99×210</button>
      <button onclick="setFormat('105×148')">А6 (105×148)</button>
      <button onclick="setFormat('148×210')">А5 (148×210)</button>
      <button onclick="setFormat('210×297')">А4 (210×297)</button>
      <button onclick="setFormat('297×420')">А3 (297×420)</button>
      <button onclick="setFormat('420×594')">А2 (420×594)</button>
    </div>
    <!-- Тираж -->
    <label>Тираж:</label>
    <input type="number" id="quantity" value="1000" oninput="onInputChange();">
    <div class="quantity-buttons" id="quantityButtons"></div>
    <!-- Цветность -->
    <label>Цветность:</label>
    <div class="side-buttons">
      <button id="btn_4_0" onclick="setSides(1)" class="selected">4+0</button>
      <button id="btn_4_4" onclick="setSides(2)">4+4</button>
    </div>
    <!-- Тип бумаги -->
    <label>Тип бумаги:</label>
    <select id="paperType" onchange="updatePaperOptions(); onInputChange();">
      <option value="offset">Офсетная</option>
      <option value="matt" selected>Мелованная</option>
      <option value="cardboard">Картон</option>
    </select>
    <!-- Плотность -->
    <label>Плотность бумаги:</label>
    <div class="paper-type-buttons" id="paperOptions"></div>
    <div id="display_paper">Выбрано: Мелованная 300 г/м²</div>
    <!-- Цена за кг -->
    <label>Цена бумаги за кг:</label>
    <input type="number" id="paperPricePerKg" value="300" oninput="onInputChange();">
  </div>
  <!-- Правая часть -->
  <div class="right">
    <table class="result-table" id="resultsBody">
      <thead>
        <tr>
          <th>Формат</th>
          <th>Изделий на листе</th>
          <th>Листов</th>
          <th>Бумага</th>
          <th>Печать</th>
          <th>Резка</th>
          <th>Ламин.</th>
          <th>Биговка</th>
          <th>Фальц.</th>
          <th>Вырубка</th>
          <th>УФ-лак</th>
          <th>Тиснение</th>
          <th>Сборка</th>
          <th>Итого</th>
        </tr>
      </thead>
      <tbody id="resultsTable">
        <tr><td colspan="14">Нажмите «Рассчитать» для вывода результата</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Сохранённые результаты -->
<div class="saved-list">
  <h3>Себестоимость</h3>
  <p id="savedMessage_cost">Пока нет данных</p>
  <div id="savedCalculations_cost"></div>
</div>
<div class="saved-list">
  <h3>Цена продажи</h3>
  <p id="savedMessage_price">Пока нет данных</p>
  <div id="savedCalculations_price"></div>
</div>
<div class="saved-list">
  <h3>Прибыль</h3>
  <p id="savedMessage_profit">Пока нет данных</p>
  <div id="savedCalculations_profit"></div>
</div>

<!-- Наценка -->
<div style="margin-top: 15px;">
  <label>Наценка (%):</label>
  <input type="number" id="markupPercent" value="20" oninput="onInputChange()" style="width: 100%;">
</div>
<button onclick="copyToClipboard()" style="margin-top: 10px;">💾 Копировать в буфер</button>
<input type="hidden" id="densityInput" value="300">

<!-- Константы -->
<div style="margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px;">
  <h3>🔧 Константы для расчётов</h3>
  <div style="margin-bottom: 20px;">
    <h4>📄 Стоимость бумаги за кг</h4>
    <ul>
      <li><strong>Офсетная:</strong> 125 руб./кг</li>
      <li><strong>Мелованная:</strong> 135 руб./кг (до 200 г/м²), 155 руб./кг (свыше)</li>
      <li><strong>Картон:</strong> 160 руб./кг</li>
    </ul>
  </div>
  <div style="margin-bottom: 20px;">
    <h4>🖨️ Стоимость печати</h4>
    <ul>
      <li><strong>SRA3 (цифра):</strong> 15 руб./лист + приладка 300 руб.</li>
      <li><strong>B2 (цифра):</strong> 50 руб./лист + приладка 500 руб.</li>
      <li><strong>А2 (офсет):</strong> 2 руб./лист + приладка 10 000 руб.</li>
    </ul>
  </div>
  <div style="margin-bottom: 20px;">
    <h4>✂️ Послепечатные работы</h4>
    <ul>
      <li><strong>Резка:</strong> 1 руб./лист + настройка 300 руб.</li>
      <li><strong>Ламинация:</strong> 12 руб./лист + настройка 300 руб.</li>
      <li><strong>Биговка:</strong> 2 руб./биг + настройка 300 руб.</li>
      <li><strong>Фальцовка:</strong> 1 руб./изделие + настройка 300 руб.</li>
      <li><strong>Вырубка:</strong> 5 руб./изделие + настройка 5000 руб. + штамп 5500 руб.</li>
      <li><strong>УФ-лак:</strong> 10 руб./лист + настройка 5000 руб.</li>
      <li><strong>Тиснение:</strong> 10 руб./изделие + настройка 4500 руб. + клише 2000 руб.</li>
      <li><strong>Сборка:</strong> 5 руб./изделие + настройка 300 руб.</li>
    </ul>
  </div>
</div>

<script>
let s = 1;
const formatLabels = {
  Z: "Цифра SRA3",
  E: "Цифра B2",
  A: "Офсет 50×70",
  B: "Офсет 47×62",
  R: "Офсет 47×65",
  M: "Офсет 52×72"
};
const sheetFormats = [
  { name: "Z", paperSize: { w: 320, h: 450 }, printArea: { w: 310, h: 430 } },
  { name: "E", paperSize: { w: 520, h: 720 }, printArea: { w: 500, h: 710 } },
  { name: "B", paperSize: { w: 470, h: 620 }, printArea: { w: 450, h: 610 } },
  { name: "R", paperSize: { w: 470, h: 650 }, printArea: { w: 450, h: 640 } },
  { name: "A", paperSize: { w: 500, h: 700 }, printArea: { w: 480, h: 690 } },
  { name: "M", paperSize: { w: 520, h: 720 }, printArea: { w: 500, h: 710 } }
];
const densityMap = {
  offset: [80, 100, 120, 160, 190],
  matt: [90, 115, 130, 150, 170, 200, 250, 300],
  cardboard: [215, 230, 250, 270, 300, 320, 350]
};
let savedResults = [];
let selectedProductType = "";
function setSides(val) {
  s = val;
  document.querySelectorAll(".side-buttons button").forEach(btn => btn.classList.remove("selected"));
  if (val === 1) {
    document.getElementById("btn_4_0").classList.add("selected");
  } else {
    document.getElementById("btn_4_4").classList.add("selected");
  }
  onInputChange();
}
function setFormat(sizeStr) {
  const size = sizeStr.split("×");
  document.getElementById("width").value = size[0];
  document.getElementById("height").value = size[1];
  updateFormatButtons();
  onInputChange();
}
function updateFormatButtons() {
  const currentW = Number(document.getElementById("width").value);
  const currentH = Number(document.getElementById("height").value);
  document.querySelectorAll("#formatButtons button").forEach(btn => {
    const btnText = btn.textContent.trim().match(/(\d+)×(\d+)/)?.[0] || "";
    btn.classList.remove("selected");
    if (btnText === `${currentW}×${currentH}` || btnText === `${currentH}×${currentW}`) {
      btn.classList.add("selected");
    }
  });
}
function updatePaperOptions() {
  const paperType = document.getElementById("paperType").value;
  const optionsDiv = document.getElementById("paperOptions");
  optionsDiv.innerHTML = "";
  const densities = densityMap[paperType] || [];
  if (!densities.length) return;
  densities.forEach(d => {
    const btn = document.createElement("button");
    btn.textContent = d + " г/м²";
    btn.onclick = () => {
      document.querySelectorAll("#paperOptions button").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      document.getElementById("densityInput").value = d;
      const price = getPaperPriceByTypeAndDensity(paperType, d);
      document.getElementById("paperPricePerKg").value = price;
      onInputChange();
    };
    optionsDiv.appendChild(btn);
  });
  if (optionsDiv.children.length > 0) optionsDiv.children[0].click();
}
function getPaperPriceByTypeAndDensity(paperType, density) {
  if (paperType === "offset") return 125;
  if (paperType === "matt") return density <= 200 ? 135 : 155;
  if (paperType === "cardboard") return 160;
  return 0;
}
function togglePostpress() {
  const panel = document.getElementById("postpressPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  document.getElementById("btnPostpress").textContent =
    panel.style.display === "none" ? "⚙️ Послепечатные работы ▼" : "⚙️ Послепечатные работы ▲";
}
function updateSubFields() {
  const fields = [
    { checkboxId: 'laminationEnabled', containerId: 'laminationOptions' },
    { checkboxId: 'scoreEnabled', containerId: 'scoreOptions' },
    { checkboxId: 'foldingEnabled', containerId: 'foldingOptions' },
    { checkboxId: 'diecutEnabled', containerId: 'diecutOptions' },
    { checkboxId: 'uvLacquerEnabled', containerId: 'uvLacquerOptions' },
    { checkboxId: 'embossingEnabled', containerId: 'embossingOptions' },
    { checkboxId: 'assemblyEnabled', containerId: 'assemblyOptions' },
    { checkboxId: 'cuttingEnabled', containerId: 'cuttingOptions' }
  ];
  fields.forEach(({ checkboxId, containerId }) => {
    const isChecked = document.getElementById(checkboxId)?.checked ?? false;
    document.getElementById(containerId).style.display = isChecked ? "block" : "none";
  });
  onInputChange();
}
function onInputChange() {
  calculate();
  renderSavedList();
}
function calculate() {
  const resultsTable = document.getElementById("resultsTable");
  resultsTable.innerHTML = "";
  const w = Number(document.getElementById("width").value);
  const h = Number(document.getElementById("height").value);
  const N = Number(document.getElementById("quantity").value);
  const density = Number(document.getElementById("densityInput").value);
  const paperPricePerKg = Number(document.getElementById("paperPricePerKg").value);
  const paperType = document.getElementById("paperType").value;
  const c_p_Z = Number(document.getElementById("printCostZ").value);
  const P_Z = Number(document.getElementById("setupPrintZ").value);
  const c_p_E = Number(document.getElementById("printCostE").value);
  const P_E = Number(document.getElementById("setupPrintE").value);
  const c_p_Offset = Number(document.getElementById("printCostOffsetA2").value);
  const P_Offset = Number(document.getElementById("setupPrintOffsetA2").value);
  const cuttingEnabled = document.getElementById("cuttingEnabled")?.checked ?? false;
  const cuttingCost = Number(document.getElementById("cuttingCostSetting").value) || 0;
  const setupCutting = Number(document.getElementById("setupCutting").value) || 0;
  const laminationEnabled = document.getElementById("laminationEnabled")?.checked ?? false;
  const laminationCost = Number(document.getElementById("laminationCost").value) || 0;
  const setupLamination = Number(document.getElementById("setupLamination").value) || 0;
  const laminationSides = document.querySelector('input[name="laminationSides"]:checked')?.value ?? "1+0";
  const scoreEnabled = document.getElementById("scoreEnabled")?.checked ?? false;
  const scoreCost = Number(document.getElementById("scoreCost").value) || 0;
  const setupScore = Number(document.getElementById("setupScore").value) || 0;
  const scoreCount = Number(document.getElementById("scoreCountInput").value) || 0;
  const foldingEnabled = document.getElementById("foldingEnabled")?.checked ?? false;
  const foldingCost = Number(document.getElementById("foldingCostSetting").value) || 0;
  const setupFolding = Number(document.getElementById("setupFolding").value) || 0;
  const diecutEnabled = document.getElementById("diecutEnabled")?.checked ?? false;
  const diecutCost = Number(document.getElementById("diecutCostSetting").value) || 0;
  const setupDiecut = Number(document.getElementById("setupDiecut").value) || 0;
  const diecutStampCost = Number(document.getElementById("diecutStampCostSetting").value) || 0;
  const uvLacquerEnabled = document.getElementById("uvLacquerEnabled")?.checked ?? false;
  const uvLacquerCost = Number(document.getElementById("uvLacquerCostSetting").value) || 0;
  const setupUvLacquer = Number(document.getElementById("setupUvLacquer").value) || 0;
  const embossingEnabled = document.getElementById("embossingEnabled")?.checked ?? false;
  const embossingCost = Number(document.getElementById("embossingCostSetting").value) || 0;
  const setupEmbossing = Number(document.getElementById("setupEmbossing").value) || 0;
  const embossingKlischeCost = Number(document.getElementById("embossingKlischeCostSetting").value) || 0;
  const assemblyEnabled = document.getElementById("assemblyEnabled")?.checked ?? false;
  const assemblyCost = Number(document.getElementById("assemblyCostSetting").value) || 0;
  const setupAssembly = Number(document.getElementById("setupAssembly").value) || 0;
  sheetFormats.forEach(sheet => {
    const W = w + 4;
    const H = h + 4;
    const printW = sheet.printArea.w;
    const printH = sheet.printArea.h;
    const v1 = Math.floor(printW / W) * Math.floor(printH / H);
    const v2 = Math.floor(printW / H) * Math.floor(printH / W);
    const N_opt = Math.max(v1, v2);
    const baseSheets = N > 0 ? Math.ceil(N / N_opt) : 0;
    const extraSheets = ["Z", "E"].includes(sheet.name) ? 3 : 250;
    const totalSheets = baseSheets + extraSheets;
    const areaSheet = (sheet.paperSize.w / 1000) * (sheet.paperSize.h / 1000);
    const weightSheet = areaSheet * (density / 1000);
    const paperTotal = weightSheet * paperPricePerKg * totalSheets;
    const printCostPerSheet = sheet.name === "Z" ? c_p_Z :
                             sheet.name === "E" ? c_p_E : c_p_Offset;
    const setupPrintValue = sheet.name === "Z" ? P_Z :
                           sheet.name === "E" ? P_E : P_Offset;
    const printTotal = printCostPerSheet * totalSheets * s + setupPrintValue;
    const cuttingTotal = cuttingEnabled ? cuttingCost * totalSheets + setupCutting : 0;
    const laminationTotal = laminationEnabled ?
      laminationCost * totalSheets * (laminationSides === "1+1" ? 2 : 1) + setupLamination : 0;
    const scoreTotal = scoreEnabled ? N * scoreCount * scoreCost + setupScore : 0;
    const foldingTotal = foldingEnabled ? N * foldingCost + setupFolding : 0;
    const diecutTotal = diecutEnabled ? N * diecutCost + setupDiecut + diecutStampCost : 0;
    const uvLacquerTotal = uvLacquerEnabled ? uvLacquerCost * totalSheets + setupUvLacquer : 0;
    const embossingTotal = embossingEnabled ? N * embossingCost + setupEmbossing + embossingKlischeCost : 0;
    const assemblyTotal = assemblyEnabled ? N * assemblyCost + setupAssembly : 0;
    const total = paperTotal + printTotal + cuttingTotal + laminationTotal + scoreTotal +
                  foldingTotal + diecutTotal + uvLacquerTotal + embossingTotal + assemblyTotal;
    const roundedTotal = Math.round(total / 10) * 10;
    const row = document.createElement("tr");
    if (N_opt === 0 && N > 0) {
      row.innerHTML = `<td colspan="14">Не помещается</td>`;
    } else {
      row.innerHTML = `
        <td>
          <button class="remember-btn" 
            onclick='rememberResult("${sheet.name}", "${w}×${h}", "${s === 1 ? "4+0" : "4+4"}", "${paperType}", ${density}, ${N}, ${roundedTotal.toFixed(2)},
              ${cuttingEnabled}, ${laminationEnabled}, "${laminationSides}", ${scoreEnabled}, ${foldingEnabled}, ${diecutEnabled}, ${uvLacquerEnabled}, ${embossingEnabled}, ${assemblyEnabled})'>
            ➕ ${formatLabels[sheet.name]}
          </button>
        </td>
        <td>${N_opt}</td>
        <td>${totalSheets}</td>
        <td>${paperTotal.toFixed(2)}</td>
        <td>${printTotal.toFixed(2)}</td>
        <td>${cuttingEnabled ? cuttingTotal.toFixed(2) : "—"}</td>
        <td>${laminationEnabled ? laminationTotal.toFixed(2) : "—"}</td>
        <td>${scoreEnabled ? scoreTotal.toFixed(2) : "—"}</td>
        <td>${foldingEnabled ? foldingTotal.toFixed(2) : "—"}</td>
        <td>${diecutEnabled ? diecutTotal.toFixed(2) : "—"}</td>
        <td>${uvLacquerEnabled ? uvLacquerTotal.toFixed(2) : "—"}</td>
        <td>${embossingEnabled ? embossingTotal.toFixed(2) : "—"}</td>
        <td>${assemblyEnabled ? assemblyTotal.toFixed(2) : "—"}</td>
        <td><b>${roundedTotal.toFixed(2)}</b></td>
      `;
    }
    resultsTable.appendChild(row);
  });
}
function rememberResult(format, productSize, color, paperType, density, quantity, cost,
                        cuttingEnabled, laminationEnabled, laminationSides,
                        scoreEnabled, foldingEnabled, diecutEnabled, uvLacquerEnabled, embossingEnabled, assemblyEnabled) {
  const key = JSON.stringify({ format, productSize, color, paperType, density, quantity, cost });
  if (savedResults.some(r => JSON.stringify(r) === key)) {
    alert("❗ Такой вариант уже запомнен.");
    return;
  }
  savedResults.push({
    format, productSize, color, paperType, density, quantity, cost,
    productType: selectedProductType,
    cuttingEnabled, laminationEnabled, laminationSides,
    scoreEnabled, foldingEnabled, diecutEnabled, uvLacquerEnabled, embossingEnabled, assemblyEnabled,
    priceOverride: null // <-- новое поле
  });
  renderSavedList();
}
function renderSavedList() {
  const listCost = document.getElementById("savedCalculations_cost");
  const listPrice = document.getElementById("savedCalculations_price");
  const listProfit = document.getElementById("savedCalculations_profit");
  [listCost, listPrice, listProfit].forEach(list => {
    while (list.firstChild) list.removeChild(list.firstChild);
  });
  if (savedResults.length === 0) {
    document.getElementById("savedMessage_cost").style.display = "block";
    document.getElementById("savedMessage_price").style.display = "block";
    document.getElementById("savedMessage_profit").style.display = "block";
    return;
  }
  document.getElementById("savedMessage_cost").style.display = "none";
  document.getElementById("savedMessage_price").style.display = "none";
  document.getElementById("savedMessage_profit").style.display = "none";
  const markupFactor = (100 + Number(document.getElementById("markupPercent").value || 20)) / 100;
  savedResults.forEach((res, index) => {
    const cost = res.cost;
    const hasOverride = res.priceOverride !== null;
    const priceWithMarkup = hasOverride ? res.priceOverride : cost * markupFactor;
    const profit = priceWithMarkup - cost;
    const postpress = [];
    if (res.cuttingEnabled) postpress.push("Резка");
    if (res.laminationEnabled) postpress.push("Ламинация " + res.laminationSides);
    if (res.scoreEnabled) postpress.push("Биговка");
    if (res.foldingEnabled) postpress.push("Фальцовка");
    if (res.diecutEnabled) postpress.push("Вырубка");
    if (res.uvLacquerEnabled) postpress.push("УФ-лак");
    if (res.embossingEnabled) postpress.push("Тиснение");
    if (res.assemblyEnabled) postpress.push("Сборка");
    const postpressText = postpress.length ? ", " + postpress.join(", ") : "";
    const title = res.productType ? `${res.productType}, ` : "";
    // Себестоимость
    const divCost = document.createElement("div");
    divCost.className = "saved-item";
    divCost.innerHTML = `<strong>${title}${res.productSize}</strong>, ${res.color}, ${getPaperTypeLabel(res.paperType)} ${res.density} г/м²${postpressText} — ${res.quantity} шт → <b>${cost} руб.</b><hr>`;
    listCost.appendChild(divCost);
    // Цена продажи (+ кнопка)
    const divPrice = document.createElement("div");
    divPrice.className = "saved-item";
    divPrice.innerHTML = `
      <strong>${title}${res.productSize}</strong>, ${res.color}, ${getPaperTypeLabel(res.paperType)} ${res.density} г/м²${postpressText} — ${res.quantity} шт → 
      <b>${priceWithMarkup.toFixed(2)} руб.</b>
      <button onclick='increasePrice(${index})' style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">+500</button>
      <hr>`;
    listPrice.appendChild(divPrice);
    // Прибыль
    const divProfit = document.createElement("div");
    divProfit.className = "saved-item";
    divProfit.innerHTML = `<strong>${title}${res.productSize}</strong>, ${res.color}, ${getPaperTypeLabel(res.paperType)} ${res.density} г/м²${postpressText} — ${res.quantity} шт → <b>${profit.toFixed(2)} руб.</b><hr>`;
    listProfit.appendChild(divProfit);
  });
}
function increasePrice(index) {
  if (savedResults[index]) {
    const currentCost = savedResults[index].cost;
    const currentPrice = savedResults[index].priceOverride !== null ?
                         savedResults[index].priceOverride :
                         currentCost * ((100 + Number(document.getElementById("markupPercent").value || 20)) / 100);
    savedResults[index].priceOverride = currentPrice + 500;
    renderSavedList();
  }
}
function getPaperTypeLabel(type) {
  return type === "offset" ? "Офсетная" :
         type === "matt" ? "Мелованная" :
         type === "cardboard" ? "Картон" : type;
}
function copyToClipboard() {
  if (savedResults.length === 0) {
    alert("Нет данных для копирования");
    return;
  }
  let text = "";
  const markupPercent = Number(document.getElementById("markupPercent").value || 20);
  const markupFactor = (100 + markupPercent) / 100;
  savedResults.forEach(res => {
    const cost = res.cost;
    const hasOverride = res.priceOverride !== null;
    const price = hasOverride ? res.priceOverride : cost * markupFactor;
    const formattedPrice = price.toFixed(2);
    const postpress = [];
    if (res.cuttingEnabled) postpress.push("Резка");
    if (res.laminationEnabled) postpress.push("Ламинация " + res.laminationSides);
    if (res.scoreEnabled) postpress.push("Биговка");
    if (res.foldingEnabled) postpress.push("Фальцовка");
    if (res.diecutEnabled) postpress.push("Вырубка");
    if (res.uvLacquerEnabled) postpress.push("УФ-лак");
    if (res.embossingEnabled) postpress.push("Тиснение");
    if (res.assemblyEnabled) postpress.push("Сборка");
    const postpressText = postpress.length ? ", " + postpress.join(", ") : "";
    const title = res.productType ? `${res.productType}, ` : "";
    text += `${title}${res.productSize}, ${res.color}, ${getPaperTypeLabel(res.paperType)} ${res.density} г/м²${postpressText} — ${res.quantity} шт → ${formattedPrice} руб.\n`;
  });
  navigator.clipboard.writeText(text).then(() => {
    alert("Цены скопированы в буфер обмена!");
  }).catch(() => {
    alert("Ошибка копирования");
  });
}
function togglePrintSettings() {
  const panel = document.getElementById("printSettingsPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
  document.getElementById("btnPrint").textContent =
    panel.style.display === "none" ? "⚙️ Печать ▼" : "⚙️ Печать ▲";
}
function updateQuantityButtons() {
  const N = Number(document.getElementById("quantity").value);
  document.querySelectorAll("#quantityButtons button").forEach(btn => {
    const qty = Number(btn.dataset.qty || btn.textContent.replace(/\D+/g, ""));
    btn.classList.toggle("selected", N === qty);
  });
  if (!document.getElementById("quantityButtons").children.length) {
    const quantities = [50, 100, 200, 300, 500, 1000, 3000, 5000];
    const container = document.getElementById("quantityButtons");
    quantities.forEach(qty => {
      const btn = document.createElement("button");
      btn.textContent = qty + " шт.";
      btn.dataset.qty = qty;
      btn.onclick = () => {
        document.getElementById("quantity").value = qty;
        document.querySelectorAll("#quantityButtons button").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        onInputChange();
      };
      container.appendChild(btn);
    });
  }
}
function selectProductType(btn) {
  document.querySelectorAll("#productTypeButtons button").forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
  selectedProductType = btn.getAttribute("data-type");
}
window.onload = () => {
  updatePaperOptions();
  updateFormatButtons();
  updateQuantityButtons();
  document.getElementById("width").oninput = onInputChange;
  document.getElementById("height").oninput = onInputChange;
  document.getElementById("quantity").oninput = onInputChange;
  document.getElementById("paperType").onchange = updatePaperOptions;
  document.getElementById("cuttingEnabled").onchange = updateSubFields;
  document.getElementById("laminationEnabled").onchange = updateSubFields;
  document.getElementById("scoreEnabled").onchange = updateSubFields;
  document.getElementById("foldingEnabled").onchange = updateSubFields;
  document.getElementById("diecutEnabled").onchange = updateSubFields;
  document.getElementById("uvLacquerEnabled").onchange = updateSubFields;
  document.getElementById("embossingEnabled").onchange = updateSubFields;
  document.getElementById("assemblyEnabled").onchange = updateSubFields;
  document.querySelectorAll('input[name="laminationSides"]').forEach(radio => radio.onchange = onInputChange);
  document.getElementById("scoreCountInput").oninput = onInputChange;
  document.getElementById("foldingCostSetting").oninput = onInputChange;
  document.getElementById("diecutCostSetting").oninput = onInputChange;
  document.getElementById("uvLacquerCostSetting").oninput = onInputChange;
  document.getElementById("embossingCostSetting").oninput = onInputChange;
  document.getElementById("assemblyCostSetting").oninput = onInputChange;
  document.getElementById("setupAssembly").oninput = onInputChange;
  onInputChange();
};
</script>
</body>
</html>
